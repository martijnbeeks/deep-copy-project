import { NextRequest, NextResponse } from 'next/server'
import { getDeepCopyAccessToken } from '@/lib/auth/deepcopy-auth'
import { requireAuth, createAuthErrorResponse } from '@/lib/auth/user-auth'
import { handleApiError } from '@/lib/middleware/error-handler'
import { incrementOrganizationUsage } from '@/lib/db/queries'
import { recordJobCreditEvent } from '@/lib/services/billing'
import { getUserOrganization, checkUsageLimit } from '@/lib/middleware/usage-limits'
import { JOB_CREDITS_BY_TYPE } from '@/lib/constants/job-credits'
import type { UsageType } from '@/lib/db/types'

const BACKEND_API_URL = 'https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const authResult = await requireAuth(request)
    if (authResult.error) {
      return createAuthErrorResponse(authResult)
    }

    const { id } = params
    const searchParams = request.nextUrl.searchParams
    const creditType = searchParams.get('creditType') as UsageType | null

    if (!id) {
      return NextResponse.json(
        { error: 'Job ID is required' },
        { status: 400 }
      )
    }

    // Determine credit type: templates_images for new templates, static_ads for old prelanders
    const finalCreditType: UsageType = creditType === 'templates_images' ? 'templates_images' : 'static_ads'

    // Get backend auth token
    const token = await getDeepCopyAccessToken()

    // Call backend API
    const response = await fetch(`${BACKEND_API_URL}prelander-images/${id}/result`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    })

    if (response.status === 404) {
      return NextResponse.json(
        { error: 'Result not available' },
        { status: 404 }
      )
    }

    if (!response.ok) {
      const errorText = await response.text()
      let errorData: any
      try {
        errorData = JSON.parse(errorText)
      } catch {
        errorData = { error: errorText }
      }
      return NextResponse.json(
        { error: errorData.error || `Backend API error: ${response.status}` },
        { status: response.status }
      )
    }

    const data = await response.json()

    // If result is completed and has images, deduct credits per image
    // Backend returns { success: true, images: [...] } when completed
    if (data.success && data.images && Array.isArray(data.images) && data.images.length > 0) {
      const user = authResult.user
      const organizationId = await getUserOrganization(user)
      
      if (organizationId) {
        try {
          // Use job credits system for templates_images, usage tracking for static_ads
          if (finalCreditType === 'templates_images') {
            // Record job credit events for Stripe billing (1 credit per image, same as static_ads)
            for (const [index, image] of data.images.entries()) {
              const imageJobId = `${id}_image_${index}` // Unique ID for each image
              await recordJobCreditEvent({
                userId: user.id,
                jobId: imageJobId,
                jobType: 'templates_images',
                credits: JOB_CREDITS_BY_TYPE.templates_images // 1 credit per image
              })
              console.log(`üí∞ Recorded job credit event for templates_images image ${index + 1}`)
            }
          } else {
            // Legacy static_ads: use old usage tracking system
            for (const image of data.images) {
              // Check limit before incrementing
              const limitCheck = await checkUsageLimit(user, finalCreditType)
              
              if (!limitCheck.allowed) {
                console.warn(`‚ö†Ô∏è Limit reached - skipping credit increment for ${finalCreditType} image`)
                // Don't increment if limit is reached, but still return the result
                // (image was already generated by external API, we just won't count it)
              } else {
                // Limit not reached, safe to increment
                await incrementOrganizationUsage(organizationId, finalCreditType)
                console.log(`üí∞ Incremented credit usage for ${finalCreditType} image`)
              }
            }
          }
        } catch (creditError: any) {
          // Log but don't fail the request if credit increment fails
          console.error(`‚ö†Ô∏è Failed to record credit usage: ${creditError.message}`)
        }
      }
    }

    return NextResponse.json(data)
  } catch (error) {
    return handleApiError(error)
  }
}

