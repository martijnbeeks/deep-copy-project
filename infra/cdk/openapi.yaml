openapi: 3.1.0
info:
  title: DeepCopy API
  version: 1.0.0
  description: |
    API for submitting AI processing jobs and retrieving their status and results.

    Authentication (OAuth2 client credentials via Amazon Cognito):

    ```bash
    # Set endpoints (from CDK outputs)
    API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
    TOKEN_ENDPOINT="https://deepcopy-613663743323-eu-west-1.auth.eu-west-1.amazoncognito.com/oauth2/token"

    # Your app client credentials (retrieve secret from Cognito console)
    CLIENT_ID="<your-client-id>"
    CLIENT_SECRET="<your-client-secret>"

    # Request access token with read+write scopes
    ACCESS_TOKEN=$(curl -s -u "$CLIENT_ID:$CLIENT_SECRET" \
      -d "grant_type=client_credentials&scope=https://deep-copy.api/read https://deep-copy.api/write" \
      "$TOKEN_ENDPOINT" | jq -r .access_token)

    echo "Token acquired: ${#ACCESS_TOKEN} chars"

    # Submit a job
    curl -sS -X POST \
      -H "Authorization: Bearer $ACCESS_TOKEN" \
      -H "content-type: application/json" \
      -d '{
        "sales_page_url": "https://try.meritrelief.com/",
        "project_name": "meritrelief",
        "swipe_file_id": "L00005",
        "advertorial_type": "Listicle",
        "persona": "Health-conscious professionals",
        "age_range": "30-45",
        "gender": "female"
      }' \
      "${API_URL}jobs"

    # Get job status (replace with real jobId)
    curl -sS -H "Authorization: Bearer $ACCESS_TOKEN" "${API_URL}jobs/YOUR_JOB_ID"

    # Get job result JSON (404 until available)
    curl -sS -H "Authorization: Bearer $ACCESS_TOKEN" "${API_URL}jobs/YOUR_JOB_ID/result"
    ```
servers:
  - url: https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/
security:
  - cognitoOAuth2: [ ]
paths:
  /jobs:
    post:
      summary: Submit a new job
      operationId: submitJob
      security:
        - cognitoOAuth2:
            - https://deep-copy.api/write
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitJobRequest'
            examples:
              minimal:
                summary: Minimal payload
                value: {}
              full:
                summary: Full payload
                value:
                  sales_page_url: "https://try.meritrelief.com/"
                  project_name: "meritrelief"
                  swipe_file_id: "L00005"
                  advertorial_type: "Listicle"
                  customer_avatars:
                    - persona_name: "Active Senior"
                      description: "Retired professional who enjoys gardening and light exercise but struggles with chronic sciatic pain"
                      age_range: "60-75"
                      gender: "both"
                      key_buying_motivation: "Seeking non-invasive pain relief to maintain active lifestyle"
                    - persona_name: "Desk-Bound Professional"
                      description: "Office worker sitting 8+ hours daily experiencing lower back pain"
                      age_range: "30-45"
                      gender: "both"
                      key_buying_motivation: "Quick relief from work-related pain"
      responses:
        '202':
          description: Job accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitJobResponse'
              examples:
                accepted:
                  value:
                    jobId: "c3f0e0c4-3a61-4c52-8b5a-2e0a8b8b4a5f"
                    taskArn: "arn:aws:ecs:eu-west-1:123456789012:task/cluster/1234567890abcdef"
                    status: "SUBMITTED"
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-codeSamples:
        - lang: bash
          label: curl (submit)
          source: |-
            API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
            curl -sS -X POST \
              -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "content-type: application/json" \
              -d '{
                "sales_page_url": "https://try.meritrelief.com/",
                "project_name": "meritrelief",
                "swipe_file_id": "L00005",
                "advertorial_type": "Listicle",
                "customer_avatars": [
                  {
                    "persona_name": "Active Senior",
                    "description": "Retired professional who enjoys gardening and light exercise but struggles with chronic sciatic pain",
                    "age_range": "60-75",
                    "gender": "both",
                    "key_buying_motivation": "Seeking non-invasive pain relief to maintain active lifestyle"
                  }
                ]
              }' \
              "${API_URL}jobs"
  /jobs/{id}:
    get:
      summary: Get job status
      operationId: getJob
      security:
        - cognitoOAuth2:
            - https://deep-copy.api/read
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '404':
          description: Job not found
          content:
            text/plain:
              schema:
                type: string
                example: "Not found"
        '500':
          description: Server error
          content:
            text/plain:
              schema:
                type: string
      x-codeSamples:
        - lang: bash
          label: curl (status)
          source: |-
            API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
            curl -sS -H "Authorization: Bearer $ACCESS_TOKEN" "${API_URL}jobs/YOUR_JOB_ID"
  /jobs/{id}/result:
    get:
      summary: Get job result
      operationId: getJobResult
      security:
        - cognitoOAuth2:
            - https://deep-copy.api/read
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job result JSON or text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResult'
            text/plain:
              schema:
                type: string
        '404':
          description: Result not available
          content:
            text/plain:
              schema:
                type: string
                example: "Result not available"
        '500':
          description: Server error
          content:
            text/plain:
              schema:
                type: string
      x-codeSamples:
        - lang: bash
          label: curl (result)
          source: |-
            API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
            curl -sS -H "Authorization: Bearer $ACCESS_TOKEN" "${API_URL}jobs/YOUR_JOB_ID/result"
  /avatars/extract:
    post:
      summary: Extract customer avatars from a product page
      operationId: extractAvatars
      security:
        - cognitoOAuth2:
            - https://deep-copy.api/write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url:
                  type: string
                  format: uri
                  description: URL of the product page to analyze
            examples:
              sciatica:
                summary: Sciatica product
                value:
                  url: "https://www.sciatiease.com/sciatiease.php"
      responses:
        '200':
          description: Successfully extracted avatars
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvatarExtractionResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-codeSamples:
        - lang: bash
          label: curl (extract avatars)
          source: |-
            API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
            curl -sS -X POST \
              -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "content-type: application/json" \
              -d '{"url": "https://www.sciatiease.com/sciatiease.php"}' \
              "${API_URL}avatars/extract"
components:
  securitySchemes:
    cognitoOAuth2:
      type: oauth2
      description: |
        OAuth2 client credentials against Amazon Cognito User Pool domain.
        Use the token endpoint output by the stack to obtain an access token.
      flows:
        clientCredentials:
          tokenUrl: https://deepcopy-613663743323-eu-west-1.auth.eu-west-1.amazoncognito.com/oauth2/token
          scopes:
            https://deep-copy.api/read: Read jobs and results
            https://deep-copy.api/write: Submit jobs
  schemas:
    SubmitJobRequest:
      type: object
      additionalProperties: true
      properties:
        sales_page_url:
          type: string
          format: uri
          description: URL to the sales page to analyze
        project_name:
          type: string
        swipe_file_id:
          type: string
          description: S3 key under content_library/ or other identifier
        advertorial_type:
          type: string
        customer_avatars:
          type: array
          description: List of customer avatars/personas to target
          items:
            $ref: '#/components/schemas/CustomerAvatar'
        persona:
          type: string
          deprecated: true
          description: (Deprecated) Use customer_avatars instead
        age_range:
          type: string
          deprecated: true
          description: (Deprecated) Use customer_avatars instead
        gender:
          type: string
          deprecated: true
          description: (Deprecated) Use customer_avatars instead
      example:
        sales_page_url: "https://try.meritrelief.com/"
        project_name: "meritrelief"
        swipe_file_id: "L00005"
        advertorial_type: "Listicle"
        customer_avatars:
          - persona_name: "Active Senior"
            description: "Retired professional who enjoys gardening and light exercise but struggles with chronic sciatic pain"
            age_range: "60-75"
            gender: "both"
            key_buying_motivation: "Seeking non-invasive pain relief to maintain active lifestyle"
          - persona_name: "Desk-Bound Professional"
            description: "Office worker sitting 8+ hours daily experiencing lower back pain"
            age_range: "30-45"
            gender: "both"
            key_buying_motivation: "Quick relief from work-related pain"
    SubmitJobResponse:
      type: object
      required: [jobId, status]
      properties:
        jobId:
          type: string
          format: uuid
        taskArn:
          type: string
          nullable: true
        status:
          type: string
          enum: [SUBMITTED]
    JobStatusResponse:
      type: object
      required: [jobId, status]
      properties:
        jobId:
          type: string
        status:
          type: string
          description: Current job status, e.g. SUBMITTED, RUNNING, SUCCEEDED, FAILED
    JobResult:
      type: object
      description: Structured JSON produced by the pipeline including rewritten advertorial content.
      additionalProperties: false
      properties:
        project_name:
          type: string
        timestamp_iso:
          type: string
          format: date-time
        job_id:
          type: string
        results:
          type: object
          additionalProperties: false
          properties:
            research_page_analysis:
              type: string
            doc1_analysis:
              type: string
            doc2_analysis:
              type: string
            deep_research_prompt:
              type: string
            deep_research_output:
              type: string
            avatar_sheet:
              type: string
            offer_brief:
              type: string
            marketing_philosophy_analysis:
              type: string
            summary:
              type: string
            swipe_results:
              type: array
              items:
                $ref: '#/components/schemas/SwipeResult'
            marketing_angles:
              type: array
              items:
                type: string
      required: [project_name, timestamp_iso, results, job_id]
    SwipeResult:
      type: object
      description: Result item for a specific marketing angle containing structured advertorial content.
      required: [angle, content]
      properties:
        angle:
          type: string
          description: Marketing angle used to generate the content.
        content:
          description: Structured content; either a Listicle or an Avertorial.
          oneOf:
            - $ref: '#/components/schemas/Listicle'
            - $ref: '#/components/schemas/Avertorial'
    ListicleItem:
      type: object
      required: [number, title, description]
      properties:
        number:
          type: integer
          description: Number of the listicle item.
        title:
          type: string
          description: Title of the listicle item.
        description:
          type: string
          description: Description of the listicle item.
    Listicle:
      type: object
      description: Structured Listicle content returned by the pipeline.
      required: [title, author, summary, listicles, cta, conclusion]
      properties:
        title:
          type: string
          description: Title of the listicle.
        author:
          type: string
          description: Author and date of the listicle.
        summary:
          type: string
          description: Intro/summary paragraph of the listicle.
        listicles:
          type: array
          description: List of listicle items.
          items:
            $ref: '#/components/schemas/ListicleItem'
        cta:
          type: string
          description: Call-to-action of the listicle.
        conclusion:
          type: string
          description: Conclusion of the listicle.
    Avertorial:
      type: object
      description: Structured Advertorial content returned by the pipeline.
      required: [title, subtitle, body, cta, captions]
      properties:
        title:
          type: string
          description: Title of the advertorial.
        subtitle:
          type: string
          description: Subtitle of the advertorial.
        body:
          type: string
          description: Body/content of the advertorial.
        cta:
          type: string
          description: Call-to-action of the advertorial.
        captions:
          type: string
          description: Captions of the advertorial.
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
    AvatarExtractionResponse:
      type: object
      required: [success, url, avatars]
      properties:
        success:
          type: boolean
        url:
          type: string
          format: uri
        avatars:
          type: array
          items:
            $ref: '#/components/schemas/CustomerAvatar'
    CustomerAvatar:
      type: object
      required: [persona_name, description, age_range, gender, key_buying_motivation]
      properties:
        persona_name:
          type: string
          description: A short, descriptive name that captures the essence of the customer
        description:
          type: string
          description: 1 sentence summarizing their lifestyle, motivations, and key challenges
        age_range:
          type: string
          description: Approximate age bracket (e.g., 25-34)
        gender:
          type: string
          description: male, female, or both
        key_buying_motivation:
          type: string
          description: What drives them to purchase this product
