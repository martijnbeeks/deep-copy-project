openapi: 3.1.0
info:
  title: DeepCopy API
  version: 1.0.0
  description: |
    API for submitting AI processing jobs and retrieving their status and results.

    Authentication (OAuth2 client credentials via Amazon Cognito):

    ```bash
    # Set endpoints (from CDK outputs)
    API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
    TOKEN_ENDPOINT="https://deepcopy-613663743323-eu-west-1.auth.eu-west-1.amazoncognito.com/oauth2/token"

    # Your app client credentials (retrieve secret from Cognito console)
    CLIENT_ID="<your-client-id>"
    CLIENT_SECRET="<your-client-secret>"

    # Request access token with read+write scopes
    ACCESS_TOKEN=$(curl -s -u "$CLIENT_ID:$CLIENT_SECRET" \
      -d "grant_type=client_credentials&scope=https://deep-copy.api/read https://deep-copy.api/write" \
      "$TOKEN_ENDPOINT" | jq -r .access_token)

    echo "Token acquired: ${#ACCESS_TOKEN} chars"

    # Submit a job
    curl -sS -X POST \
      -H "Authorization: Bearer $ACCESS_TOKEN" \
      -H "content-type: application/json" \
      -d '{
        "sales_page_url": "https://try.meritrelief.com/",
        "project_name": "meritrelief",
        "swipe_file_id": "L00005",
        "advertorial_type": "Listicle"
      }' \
      "${API_URL}jobs"

    # Get job status (replace with real jobId)
    curl -sS -H "Authorization: Bearer $ACCESS_TOKEN" "${API_URL}jobs/YOUR_JOB_ID"

    # Get job result JSON (404 until available)
    curl -sS -H "Authorization: Bearer $ACCESS_TOKEN" "${API_URL}jobs/YOUR_JOB_ID/result"
    ```
servers:
  - url: https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/
security:
  - cognitoOAuth2: [ ]
paths:
  /jobs:
    post:
      summary: Submit a new job
      operationId: submitJob
      security:
        - cognitoOAuth2:
            - https://deep-copy.api/write
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitJobRequest'
            examples:
              minimal:
                summary: Minimal payload
                value: {}
              full:
                summary: Full payload
                value:
                  sales_page_url: "https://try.meritrelief.com/"
                  project_name: "meritrelief"
                  swipe_file_id: "L00005"
                  advertorial_type: "Listicle"
      responses:
        '202':
          description: Job accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitJobResponse'
              examples:
                accepted:
                  value:
                    jobId: "c3f0e0c4-3a61-4c52-8b5a-2e0a8b8b4a5f"
                    taskArn: "arn:aws:ecs:eu-west-1:123456789012:task/cluster/1234567890abcdef"
                    status: "SUBMITTED"
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-codeSamples:
        - lang: bash
          label: curl (submit)
          source: |-
            API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
            curl -sS -X POST \
              -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "content-type: application/json" \
              -d '{
                "sales_page_url": "https://try.meritrelief.com/",
                "project_name": "meritrelief",
                "swipe_file_id": "L00005",
                "advertorial_type": "Listicle"
              }' \
              "${API_URL}jobs"
  /jobs/{id}:
    get:
      summary: Get job status
      operationId: getJob
      security:
        - cognitoOAuth2:
            - https://deep-copy.api/read
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '404':
          description: Job not found
          content:
            text/plain:
              schema:
                type: string
                example: "Not found"
        '500':
          description: Server error
          content:
            text/plain:
              schema:
                type: string
      x-codeSamples:
        - lang: bash
          label: curl (status)
          source: |-
            API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
            curl -sS -H "Authorization: Bearer $ACCESS_TOKEN" "${API_URL}jobs/YOUR_JOB_ID"
  /jobs/{id}/result:
    get:
      summary: Get job result
      operationId: getJobResult
      security:
        - cognitoOAuth2:
            - https://deep-copy.api/read
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job result JSON or text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResult'
            text/plain:
              schema:
                type: string
        '404':
          description: Result not available
          content:
            text/plain:
              schema:
                type: string
                example: "Result not available"
        '500':
          description: Server error
          content:
            text/plain:
              schema:
                type: string
      x-codeSamples:
        - lang: bash
          label: curl (result)
          source: |-
            API_URL="https://o5egokjpsl.execute-api.eu-west-1.amazonaws.com/prod/"
            curl -sS -H "Authorization: Bearer $ACCESS_TOKEN" "${API_URL}jobs/YOUR_JOB_ID/result"
components:
  securitySchemes:
    cognitoOAuth2:
      type: oauth2
      description: |
        OAuth2 client credentials against Amazon Cognito User Pool domain.
        Use the token endpoint output by the stack to obtain an access token.
      flows:
        clientCredentials:
          tokenUrl: https://deepcopy-613663743323-eu-west-1.auth.eu-west-1.amazoncognito.com/oauth2/token
          scopes:
            https://deep-copy.api/read: Read jobs and results
            https://deep-copy.api/write: Submit jobs
  schemas:
    SubmitJobRequest:
      type: object
      additionalProperties: true
      properties:
        sales_page_url:
          type: string
          format: uri
          description: URL to the sales page to analyze
        project_name:
          type: string
        swipe_file_id:
          type: string
          description: S3 key under content_library/ or other identifier
        advertorial_type:
          type: string
      example:
        sales_page_url: "https://try.meritrelief.com/"
        project_name: "meritrelief"
        swipe_file_id: "L00005"
        advertorial_type: "Listicle"
    SubmitJobResponse:
      type: object
      required: [jobId, status]
      properties:
        jobId:
          type: string
          format: uuid
        taskArn:
          type: string
          nullable: true
        status:
          type: string
          enum: [SUBMITTED]
    JobStatusResponse:
      type: object
      required: [jobId, status]
      properties:
        jobId:
          type: string
        status:
          type: string
          description: Current job status, e.g. SUBMITTED, RUNNING, SUCCEEDED, FAILED
    JobResult:
      type: object
      description: Arbitrary JSON produced by the pipeline.
      additionalProperties: true
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
